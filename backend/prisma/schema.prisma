datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_CLOUD_URL")
  directUrl = env("DIRECT_CLOUD_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["typedSql"]
}

generator json {
  provider = "prisma-json-types-generator"
}

generator nestjsDto {
  provider            = "prisma-generator-nestjs-dto"
  output              = "../src/generated/nestjs-dto"
  classValidation     = "true"
  prettier            = "true"
  wrapRelationsAsType = "true"
}

enum Role {
  student
  mentor
  admin
}

enum UserStatus {
  active
  disabled
  deleted
}

model User {
  id             String          @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  userAccount    UserAccount?
  /// @DtoApiHidden
  userDetails    UserDetails?
  /// @DtoApiHidden
  studentDetails StudentDetails?
  /// @DtoApiHidden
  staffDetails   StaffDetails?
  /// @DtoApiHidden
  bills          Bill[]
  /// @DtoApiHidden
  notifications  Notification[]
  /// @DtoApiHidden
  enrolledCourses EnrolledCourse[]
  /// @DtoApiHidden
  courseSections CourseSection[]


  firstName  String
  middleName String?
  lastName   String
  /// @DtoReadOnly
  role       Role

  /// @DtoReadOnly
  createdAt  DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt  DateTime  @updatedAt
  /// @DtoReadOnly
  disabledAt DateTime?
  /// @DtoReadOnly
  deletedAt  DateTime?
}

model UserAccount {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  authUid String  @unique
  /// @IsEmail
  email   String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model UserDetails {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dateJoined DateTime
  dob        DateTime?
  gender     String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum StudentType {
  new
  regular
  irregular
  transfer
  returnee
  graduate
  special
}

model StudentDetails {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  studentNumber Int
  studentType   StudentType
  admissionDate DateTime
  otherDetails  Json

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model StaffDetails {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  employeeNumber Int
  department     String
  position       String
  otherDetails   Json

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Program {
  id     String  @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  majors Major[]

  code        String @unique
  name        String @unique
  description String

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Major {
  id        String   @id @default(uuid()) @db.Uuid
  programId String   @db.Uuid
  /// @DtoApiHidden
  program   Program  @relation(fields: [programId], references: [id])

  /// @DtoApiHidden
  courses   Course[]

  name        String @unique
  description String

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Course {
  id    String  @id @default(uuid()) @db.Uuid

  /// @DtoApiHidden
  major Major[]

  prereqs   Course[] @relation("CoursePrereq")
  prereqFor Course[] @relation("CoursePrereq")

  coreqs   Course[] @relation("CourseCoreq")
  coreqFor Course[] @relation("CourseCoreq")

  courseCode  String @unique
  name        String
  description String
  year        String
  semester    String
  units       Int

  /// @DtoApiHidden
  courseOfferings CourseOffering[] // A course can have multiple offerings

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum EnrollmentStatus {
  draft
  upcoming
  active
  extended
  closed
  canceled
  archived
}

model EnrollmentPeriod {
  id  String @id @default(uuid()) @db.Uuid

  courseOfferings CourseOffering[] // An enrollment can have multiple offerings

  startYear Int
  endYear Int

  term Int
  
  startDate DateTime
  endDate DateTime

  status EnrollmentStatus

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model CourseOffering {
  id  String @id @default(uuid()) @db.Uuid

  courseId String @db.Uuid // Each enrollable belongs to one course
  /// @DtoApiHidden
  course Course @relation(fields: [courseId], references: [id]) 

  periodId String @db.Uuid  // Each enrollable belongs to one enrollment period
  /// @DtoApiHidden
  enrollmentPeriod EnrollmentPeriod @relation(fields: [periodId], references: [id])

  enrolledCourses EnrolledCourse[] // Each offering can have multiple enrolled

  courseSections CourseSection[] // Each offering can have multiple sections

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum Days {
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
}

model CourseSection {
  id  String @id @default(uuid()) @db.Uuid

  mentorId String @db.Uuid // Each section belong to one mentor
  /// @DtoApiHidden
  user User @relation(fields: [mentorId], references: [id])

  courseOfferingId String @db.Uuid  // Each section belong to one offering
  /// @DtoApiHidden
  courseOffering CourseOffering @relation(fields: [courseOfferingId], references: [id])

  maxSlot Int

  startSched String
  endSched String

  days Days[]

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum EnrolledCourseStatus {
  enlisted
  enrolled
  dropped
  completed
}

model EnrolledCourse {
  id  String @id @default(uuid()) @db.Uuid

  courseOfferingId String  @db.Uuid  // Each enrolled courses belong to one offering
  /// @DtoApiHidden
  courseOffering CourseOffering @relation(fields: [courseOfferingId], references: [id])

  studentId String  @db.Uuid  // Each enrolled course belong to one user i.e student
  /// @DtoApiHidden
  user User @relation(fields: [studentId], references: [id])

  status EnrolledCourseStatus
  startedAt DateTime
  completedAt DateTime

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum PaymentScheme {
  full
  installment1
  installment2
}

model Bill {
  id     String  @id @default(uuid()) @db.Uuid
  userId String? @db.Uuid

  user         User?         @relation(fields: [userId], references: [id])
  /// @DtoApiHidden
  billInstallments BillInstallment[]
  /// @DtoApiHidden
  billPayments BillPayment[]

  invoiceId     Int      @default(autoincrement())
  payerName     String
  payerEmail    String
  paymentScheme      PaymentScheme
  totalAmount   Decimal  @db.Decimal(10, 2)
  dueAt         DateTime
  /// [CostBreakdown]
  /// @DtoOverrideType(PrismaJson.CostBreakdown)
  costBreakdown Json

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model BillInstallment {
  id String @id @default(uuid()) @db.Uuid
  billId String @db.Uuid
  /// @DtoApiHidden
  bill   Bill   @relation(fields: [billId], references: [id])
  /// @DtoApiHidden
  billPayments BillPayment[]

  name String
  installmentOrder Int
  amountToPay Decimal  @db.Decimal(10, 2)
  dueAt         DateTime

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum PaymentType {
  card
  paymaya
  gcash
  qrph
  manual
}

model BillPayment {
  id     String @id @default(uuid()) @db.Uuid
  billId String @db.Uuid
  /// @DtoApiHidden
  bill   Bill   @relation(fields: [billId], references: [id])
  installmentId String? @db.Uuid
  /// @DtoApiHidden
  installment   BillInstallment?   @relation(fields: [installmentId], references: [id])

  installmentOrder Int
  amountPaid   Decimal  @db.Decimal(10, 2)
  paymentType  PaymentType
  notes        String
  paymentDate  DateTime
  /// [PayMongoData]
  /// @DtoOverrideType(PrismaJson.PayMongoData)
  paymongoData Json?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Notification {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id])

  title   String
  content String
  isRead  String

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  deletedAt DateTime?
}
