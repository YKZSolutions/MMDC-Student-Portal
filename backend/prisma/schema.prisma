datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_CLOUD_URL")
  directUrl = env("DIRECT_CLOUD_URL")
}

// datasource db {
//   provider  = "postgresql"
//   url       = env("DATABASE_URL")
// }

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["typedSql"]
}

generator json {
  provider = "prisma-json-types-generator"
}

generator nestjsDto {
  provider            = "prisma-generator-nestjs-dto"
  output              = "../src/generated/nestjs-dto"
  classValidation     = "true"
  prettier            = "true"
  wrapRelationsAsType = "true"
}

enum Role {
  student
  mentor
  admin
}

enum UserStatus {
  active
  disabled
  deleted
}

model User {
  id                   String                 @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  userAccount          UserAccount?
  /// @DtoApiHidden
  userDetails          UserDetails?
  /// @DtoApiHidden
  studentDetails       StudentDetails?
  /// @DtoApiHidden
  staffDetails         StaffDetails?
  /// @DtoApiHidden
  bills                Bill[]
  /// @DtoApiHidden
  courseEnrollment     CourseEnrollment[]
  /// @DtoApiHidden
  mentorSections       CourseSection[]
  /// @DtoApiHidden
  submittedAssignments AssignmentSubmission[]
  /// @DtoApiHidden
  grades               GradeRecord[]
  /// @DtoApiHidden
  quizAttempts         QuizSubmission[]
  /// @DtoApiHidden
  postedDiscussions    DiscussionPost[]
  /// @DtoApiHidden
  moduleProgress       ContentProgress[]
  /// @DtoApiHidden
  groups               GroupMember[]
  /// @DtoApiHidden
  appointmentStudents  Appointment[]          @relation("AppointmentStudent")
  /// @DtoApiHidden
  appointmentMentors   Appointment[]          @relation("AppointmentMentor")
  /// @DtoApiHidden
  notifications        NotificationReceipt[]

  firstName  String
  middleName String?
  lastName   String
  /// @DtoReadOnly
  role       Role

  /// @DtoReadOnly
  createdAt  DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt  DateTime  @updatedAt
  /// @DtoReadOnly
  disabledAt DateTime?
  /// @DtoReadOnly
  deletedAt  DateTime?
}

model UserAccount {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  authUid String  @unique
  /// @IsEmail
  email   String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model UserDetails {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dateJoined DateTime
  dob        DateTime?
  gender     String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum StudentType {
  new
  regular
  irregular
  transfer
  returnee
  graduate
  special
}

model StudentDetails {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  studentNumber String      @unique
  studentType   StudentType
  admissionDate DateTime
  otherDetails  Json

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  @@index(studentNumber)
}

model StaffDetails {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  /// @DtoApiHidden
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  employeeNumber Int
  department     String
  position       String
  otherDetails   Json

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Program {
  id     String  @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  majors Major[]

  programCode  String  @unique
  name         String  @unique
  description  String
  yearDuration Int
  isActive     Boolean @default(true)

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Major {
  id        String  @id @default(uuid()) @db.Uuid
  programId String  @db.Uuid
  /// @DtoApiHidden
  program   Program @relation(fields: [programId], references: [id])

  /// @DtoApiHidden
  courses Course[]

  /// @DtoApiHidden
  curriculums Curriculum[]

  majorCode   String  @unique
  name        String  @unique
  description String
  isActive    Boolean @default(true)

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Course {
  id String @id @default(uuid()) @db.Uuid

  /// @DtoApiHidden
  majors Major[]

  prereqs   Course[] @relation("CoursePrereq")
  prereqFor Course[] @relation("CoursePrereq")

  coreqs   Course[] @relation("CourseCoreq")
  coreqFor Course[] @relation("CourseCoreq")

  /// @DtoApiHidden
  modules Module[]

  curriculumCourses CurriculumCourse[]

  courseCode  String  @unique
  name        String
  description String
  units       Int
  type        String
  isActive    Boolean @default(true)

  /// @DtoApiHidden
  courseOfferings CourseOffering[] // A course can have multiple offerings

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Curriculum {
  id String @id @default(uuid()) @db.Uuid

  majorId String @db.Uuid
  /// @DtoApiHidden
  major   Major  @relation(fields: [majorId], references: [id])

  /// @DtoApiHidden
  courses CurriculumCourse[]

  icon        String?
  name        String?
  description String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model CurriculumCourse {
  id String @id @default(uuid()) @db.Uuid

  curriculumId String     @db.Uuid
  /// @DtoApiHidden
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])

  courseId String @db.Uuid
  /// @DtoApiHidden
  course   Course @relation(fields: [courseId], references: [id])

  order    Int
  year     Int
  semester Int

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  @@unique([curriculumId, courseId])
}

enum EnrollmentStatus {
  draft
  upcoming
  active
  extended
  closed
  canceled
  archived
}

model EnrollmentPeriod {
  id String @id @default(uuid()) @db.Uuid

  courseOfferings CourseOffering[] // An enrollment can have multiple offerings
  pricingGroupId  String?          @db.Uuid
  /// @DtoApiHidden
  pricingGroup    PricingGroup?    @relation(fields: [pricingGroupId], references: [id])

  startYear Int
  endYear   Int

  term Int

  startDate DateTime
  endDate   DateTime

  status EnrollmentStatus

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model CourseOffering {
  id String @id @default(uuid()) @db.Uuid

  courseId String @db.Uuid // Each offering belongs to one course
  /// @DtoApiHidden
  course   Course @relation(fields: [courseId], references: [id])

  periodId         String           @db.Uuid // Each offering belongs to one enrollment period
  /// @DtoApiHidden
  enrollmentPeriod EnrollmentPeriod @relation(fields: [periodId], references: [id])

  /// @DtoApiHidden
  courseEnrollments CourseEnrollment[] // Each offering can have multiple enrollments
  /// @DtoApiHidden
  courseSections    CourseSection[] // Each offering can have multiple sections
  /// @DtoApiHidden
  modules           Module[]
  /// @DtoApiHidden
  appointments      Appointment[]

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum Days {
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
}

model CourseSection {
  id String @id @default(uuid()) @db.Uuid

  name String

  /// @DtoApiHidden
  mentor   User?   @relation(fields: [mentorId], references: [id], onDelete: SetNull)
  mentorId String? @db.Uuid // make mentor optional

  /// @DtoApiHidden
  courseOffering   CourseOffering @relation(fields: [courseOfferingId], references: [id])
  courseOfferingId String         @db.Uuid // Each section belong to one offering

  courseEnrollments CourseEnrollment[] // Each course section has multiple student enrolled

  maxSlot Int

  startSched String
  endSched   String

  days Days[]

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  /// @DtoApiHidden
  sectionModules SectionModule[]
}

enum CourseEnrollmentStatus {
  enlisted
  finalized
  enrolled
  completed
  incomplete
  dropped
  failed
}

model CourseEnrollment {
  id String @id @default(uuid()) @db.Uuid

  /// @DtoApiHidden
  courseOffering   CourseOffering @relation(fields: [courseOfferingId], references: [id])
  courseOfferingId String         @db.Uuid // Each enrolled courses belong to one offering

  /// @DtoApiHidden
  courseSection   CourseSection @relation(fields: [courseSectionId], references: [id])
  courseSectionId String        @db.Uuid // Each student enrollment belong to one section

  /// @DtoApiHidden
  student   User   @relation(fields: [studentId], references: [id])
  studentId String @db.Uuid // Each enrolled course belong to one user i.e student

  status      CourseEnrollmentStatus
  startedAt   DateTime
  completedAt DateTime?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum BillType {
  academic
  administrative
  facilities
  studentServices
  activities
  penalties
}

enum PaymentScheme {
  full
  installment1
  installment2
}

model Bill {
  id     String  @id @default(uuid()) @db.Uuid
  userId String? @db.Uuid

  user             User?             @relation(fields: [userId], references: [id])
  /// @DtoApiHidden
  billInstallments BillInstallment[]
  /// @DtoApiHidden
  billPayments     BillPayment[]

  invoiceId     Int           @default(autoincrement())
  payerName     String
  payerEmail    String
  billType      BillType
  paymentScheme PaymentScheme
  totalAmount   Decimal       @db.Decimal(10, 2)
  /// [CostBreakdown]
  /// @DtoOverrideType(PrismaJson.CostBreakdown)
  costBreakdown Json

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model BillInstallment {
  id           String        @id @default(uuid()) @db.Uuid
  billId       String        @db.Uuid
  /// @DtoApiHidden
  bill         Bill          @relation(fields: [billId], references: [id])
  /// @DtoApiHidden
  billPayments BillPayment[]

  name             String
  installmentOrder Int
  amountToPay      Decimal  @db.Decimal(10, 2)
  dueAt            DateTime

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum PaymentType {
  card
  paymaya
  gcash
  qrph
  manual
}

model BillPayment {
  id            String           @id @default(uuid()) @db.Uuid
  billId        String           @db.Uuid
  /// @DtoApiHidden
  bill          Bill             @relation(fields: [billId], references: [id])
  installmentId String?          @db.Uuid
  /// @DtoApiHidden
  installment   BillInstallment? @relation(fields: [installmentId], references: [id])

  installmentOrder Int
  amountPaid       Decimal     @db.Decimal(10, 2)
  paymentType      PaymentType
  notes            String
  paymentDate      DateTime
  /// [PayMongoData]
  /// @DtoOverrideType(PrismaJson.PayMongoData)
  paymongoData     Json?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum PricingType {
  tuition
  lab
  misc
  other
}

model Pricing {
  id          String         @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  priceGroups PricingGroup[]

  type    PricingType
  name    String      @unique
  amount  Decimal     @db.Decimal(10, 2)
  enabled Boolean     @default(true)

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model PricingGroup {
  id                String             @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  prices            Pricing[]
  /// @DtoApiHidden
  enrollmentPeriods EnrollmentPeriod[]

  name    String
  amount  Decimal @db.Decimal(10, 2)
  enabled Boolean @default(true)

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Group {
  id String @id @default(uuid()) @db.Uuid

  moduleId String @db.Uuid
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  groupNumber Int
  groupName   String?
  /// @DtoApiHidden
  members     GroupMember[]
  /// @DtoApiHidden
  submissions AssignmentSubmission[]

  /// @DtoReadOnly
  createdAt DateTime @default(now())
  /// @DtoReadOnly
  updatedAt DateTime @updatedAt

  @@unique([moduleId, groupNumber])
}

model GroupMember {
  id String @id @default(uuid()) @db.Uuid

  groupId String @db.Uuid
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  studentId String @db.Uuid
  student   User   @relation(fields: [studentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, studentId])
}

model Module {
  id    String @id @default(uuid()) @db.Uuid
  title String

  /// @DtoApiHidden
  course   Course? @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId String? @db.Uuid

  /// @DtoApiHidden
  courseOffering   CourseOffering? @relation(fields: [courseOfferingId], references: [id])
  courseOfferingId String?         @db.Uuid

  /// @DtoApiHidden
  sectionModules SectionModule[]
  /// @DtoApiHidden
  moduleSections ModuleSection[]
  /// @DtoApiHidden
  moduleContents ModuleContent[]
  /// @DtoApiHidden
  progresses     ContentProgress[]
  /// @DtoApiHidden
  groups         Group[]

  publishedAt   DateTime?
  toPublishAt   DateTime?
  unpublishedAt DateTime?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model SectionModule {
  id              String        @id @default(uuid()) @db.Uuid
  courseSection   CourseSection @relation(fields: [courseSectionId], references: [id], onDelete: Cascade)
  courseSectionId String        @db.Uuid

  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId String @db.Uuid

  publishedAt DateTime?
  toPublishAt DateTime?

  classMeetings Json[]

  @@unique([courseSectionId, moduleId])
  @@index([courseSectionId])
  @@index([moduleId])
}

model ModuleSection {
  id String @id @default(uuid()) @db.Uuid

  /// @DtoApiHidden
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId String @db.Uuid

  // self reference subsections
  /// @DtoApiHidden
  parentSection   ModuleSection?  @relation("ModuleSubsection", fields: [parentSectionId], references: [id], onDelete: Cascade)
  parentSectionId String?         @db.Uuid
  /// @DtoApiHidden
  subsections     ModuleSection[] @relation("ModuleSubsection")

  /// @DtoApiHidden
  prerequisiteSection   ModuleSection? @relation("ModulePrerequisite", fields: [prerequisiteSectionId], references: [id])
  prerequisiteSectionId String?        @db.Uuid

  /// @DtoApiHidden
  dependentSections ModuleSection[] @relation("ModulePrerequisite")

  /// @DtoApiHidden
  moduleContents ModuleContent[]

  title String @db.VarChar(255)
  order Int?   @default(0)

  publishedAt   DateTime?
  toPublishAt   DateTime?
  unpublishedAt DateTime?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  @@index([moduleId, order])
  @@index([moduleId])
  @@index([parentSectionId])
  @@index([order])
  @@index([publishedAt])
}

enum ContentType {
  LESSON
  ASSIGNMENT
  QUIZ
  DISCUSSION
  VIDEO
  URL
  FILE
}

model ModuleContent {
  id String @id @default(uuid()) @db.Uuid

  // moduleId (content can belong to a module even if not in a section)
  // used for storing draft content that is not part of a section
  moduleId String @db.Uuid
  /// @DtoApiHidden
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // optional: if content is part of a section
  moduleSectionId String?        @db.Uuid
  /// @DtoApiHidden
  moduleSection   ModuleSection? @relation(fields: [moduleSectionId], references: [id], onDelete: Cascade)

  order       Int?        @default(0)
  contentType ContentType

  publishedAt   DateTime?
  toPublishAt   DateTime?
  unpublishedAt DateTime?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  // Relations to specific content types
  lesson     Lesson?
  assignment Assignment?
  quiz       Quiz?
  discussion Discussion?
  video      Video?
  url        ExternalUrl?
  file       FileResource?

  studentProgress ContentProgress[]

  @@unique([moduleSectionId, order])
  @@index([moduleId, contentType, publishedAt])
  @@index([moduleSectionId])
  @@index([publishedAt])
  @@index([contentType, publishedAt])
}

model Lesson {
  id              String        @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id], onDelete: Cascade)
  moduleContentId String        @unique @db.Uuid

  title    String  @db.VarChar(255)
  subtitle String? @db.VarChar(500)
  content  Json[] // Structured lesson content

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum AssignmentMode {
  INDIVIDUAL
  GROUP
}

model Assignment {
  id String @id @default(uuid()) @db.Uuid

  /// @DtoApiHidden
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id], onDelete: Cascade)
  moduleContentId String        @unique @db.Uuid

  title    String  @db.VarChar(255)
  subtitle String? @db.VarChar(500)
  content  Json[] // Structured assignment content (eg. description, instructions, submission instructions, etc.)

  mode AssignmentMode?

  maxAttempts         Int?      @db.SmallInt
  allowLateSubmission Boolean?
  latePenalty         Decimal?  @db.Decimal(5, 2)
  dueDate             DateTime?
  gracePeriodMinutes  Int?      @default(0) // Grace period in minutes

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  grading   GradingConfig? @relation(fields: [gradingId], references: [id], onDelete: Restrict)
  gradingId String?        @db.Uuid

  /// @DtoApiHidden
  submissions AssignmentSubmission[]

  @@index([moduleContentId])
  @@index([dueDate])
}

enum SubmissionState {
  // Work-in-progress submission
  // Student is still working on the assignment/quiz
  // Can be saved multiple times without counting as an attempt
  // Not visible to instructors for grading
  DRAFT

  // Student has completed and submitted work
  // Submission is now "locked in" for evaluation
  // Counts as an attempt toward maxAttempts
  // Becomes visible to instructors
  SUBMITTED

  // Instructor has started grading process
  // Prevents concurrent grading by multiple instructors
  // Provides status transparency to student
  // Allows for complex multi-stage evaluation processes
  UNDER_REVIEW

  // Final grades and feedback have been provided
  // Student can view their grade and feedback
  // Submission is now read-only
  // Marks the end of successful evaluation process
  GRADED

  // Submission requires student action/resubmission
  // Work didn't meet requirements or needs correction
  // Student can revise and resubmit (if attempts remain)
  // Creates feedback loop for improvement
  RETURNED
}

model AssignmentSubmission {
  id           String     @id @default(uuid()) @db.Uuid
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  assignmentId String     @db.Uuid

  /// @DtoApiHidden
  student   User   @relation(fields: [studentId], references: [id])
  studentId String @db.Uuid

  // Group submissions
  groupId       String? @db.Uuid
  group         Group?  @relation(fields: [groupId], references: [id])
  groupSnapshot Json?

  state SubmissionState

  gradeRecord GradeRecord?

  /// Text submission
  content       Json[]
  submittedAt   DateTime?
  attemptNumber Int       @default(1) @db.SmallInt

  // Late submission tracking
  lateDays Int? @db.SmallInt

  attachments SubmissionAttachment[]

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  @@unique([assignmentId, studentId, attemptNumber])
  @@index([assignmentId, studentId])
  @@index([submittedAt])
}

model SubmissionAttachment {
  id String @id @default(uuid()) @db.Uuid

  /// @DtoApiHidden
  assignmentSubmission   AssignmentSubmission? @relation(fields: [assignmentSubmissionId], references: [id], onDelete: Cascade)
  assignmentSubmissionId String?               @db.Uuid

  /// @DtoApiHidden
  quizSubmission   QuizSubmission? @relation(fields: [quizSubmissionId], references: [id], onDelete: Cascade)
  quizSubmissionId String?         @db.Uuid

  name String

  url  String // Files, links, Images, etc.
  type String // e.g., "document", "image", "code"
  size Int // in bytes

  /// @DtoReadOnly
  createdAt DateTime @default(now())
}

model Quiz {
  id              String        @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id], onDelete: Cascade)
  moduleContentId String        @unique @db.Uuid
  title           String        @db.VarChar(255)
  subtitle        String?       @db.VarChar(500)
  content         Json[] // Structured quiz content (eg. description, instructions, etc.)

  timeLimit           Int? // in minutes
  maxAttempts         Int?      @db.SmallInt
  allowLateSubmission Boolean?
  latePenalty         Decimal?  @db.Decimal(5, 2)
  dueDate             DateTime?
  gracePeriodMinutes  Int?      @default(0) // Grace period in minutes

  questions Json[] // Store all questions in a structured format

  // Grading per question will be overriden in the UI if present in the questions
  grading   GradingConfig? @relation(fields: [gradingId], references: [id], onDelete: Restrict)
  gradingId String?        @db.Uuid

  /// @DtoApiHidden
  submissions QuizSubmission[]

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  @@index([timeLimit])
}

model QuizSubmission {
  id        String @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  quiz      Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId    String @db.Uuid
  /// @DtoApiHidden
  student   User   @relation(fields: [studentId], references: [id])
  studentId String @db.Uuid

  state SubmissionState //Draft is when students are answering the quiz

  answers       Json[] // Student's answers
  timeSpent     Int? // in seconds
  attemptNumber Int    @default(1) @db.SmallInt

  submittedAt DateTime? @default(now())
  lateDays    Int?      @db.SmallInt

  rawScore Decimal? @db.Decimal(5, 2)

  gradeRecord GradeRecord?

  attachments SubmissionAttachment[]

  /// @DtoReadOnly
  createdAt DateTime @default(now())

  @@unique([quizId, studentId, attemptNumber])
  @@index([quizId, studentId])
  @@index([submittedAt])
}

// Defines HOW assignment is graded
// Allows reusing the same grading model for multiple assignments / quizzess
model GradingConfig {
  id String @id @default(uuid()) @db.Uuid

  // Grading schema definition
  weight        Decimal? @db.Decimal(5, 2) // For final grade calculation
  isCurved      Boolean
  curveSettings Json? // for adjusting grades (eg. adding points to all grades)

  // Config details (depending on type)
  rubricSchema  Json[] // For assignments
  questionRules Json[] // For quizzes (default grading rules for each question type)

  /// @DtoApiHidden
  assignments Assignment[]
  quizzes     Quiz[]

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  @@index([weight])
}

// defines WHAT was actually graded
model GradeRecord {
  id        String @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  student   User   @relation(fields: [studentId], references: [id])
  studentId String @db.Uuid

  // @DtoApiHidden
  assignmentSubmissionId String?               @unique @db.Uuid
  assignmentSubmission   AssignmentSubmission? @relation(fields: [assignmentSubmissionId], references: [id])

  // @DtoApiHidden
  quizSubmissionId String?         @unique @db.Uuid
  quizSubmission   QuizSubmission? @relation(fields: [quizSubmissionId], references: [id])

  // Common grade data
  rawScore   Decimal @db.Decimal(5, 2) // Actual grade data
  finalScore Decimal @db.Decimal(5, 2)
  grade      String  @db.VarChar(10) // A, B+, Pass, Fail etc.
  feedback   String?

  // Flexible detail fields
  rubricScores   Json[] // For assignments
  questionScores Json[] // For quizzes

  /// @DtoReadOnly
  gradedAt  DateTime @default(now())
  /// @DtoReadOnly
  updatedAt DateTime @updatedAt

  @@index([studentId, finalScore])
  @@index([gradedAt])
}

model Discussion {
  id              String        @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id], onDelete: Cascade)
  moduleContentId String        @unique @db.Uuid

  title    String  @db.VarChar(255)
  subtitle String? @db.VarChar(500)
  content  Json[] // Discussion prompt/question

  isThreaded  Boolean? @default(true)
  requirePost Boolean? @default(false)

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  posts DiscussionPost[]

  @@index([moduleContentId])
}

model DiscussionPost {
  id           String     @id @default(uuid()) @db.Uuid
  discussionId String     @db.Uuid
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  authorId     String     @db.Uuid
  author       User       @relation(fields: [authorId], references: [id])

  content Json

  parentId String?          @db.Uuid
  parent   DiscussionPost?  @relation("DiscussionPostReplies", fields: [parentId], references: [id])
  replies  DiscussionPost[] @relation("DiscussionPostReplies")

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?

  @@index([discussionId, parentId])
  @@index([createdAt])
}

model Video {
  id              String        @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id], onDelete: Cascade)
  moduleContentId String        @unique @db.Uuid

  title    String  @db.VarChar(255)
  subtitle String? @db.VarChar(500)
  content  Json[]

  url        String?
  duration   Int? // in seconds
  transcript String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model ExternalUrl {
  id              String        @id @default(uuid()) @db.Uuid
  /// @DtoApiHidden
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id], onDelete: Cascade)
  moduleContentId String        @unique @db.Uuid

  title    String  @db.VarChar(255)
  subtitle String? @db.VarChar(500)
  content  Json[]

  url String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model FileResource {
  id              String        @id @default(uuid()) @db.Uuid
  moduleContentId String        @unique @db.Uuid
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id], onDelete: Cascade)

  title    String  @db.VarChar(255)
  subtitle String? @db.VarChar(500)
  content  Json[]

  url String? //download url

  name     String?
  path     String?
  size     Int? // in bytes
  mimeType String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model ContentProgress {
  id String @id @default(uuid()) @db.Uuid

  /// @DtoApiHidden
  student   User   @relation(fields: [studentId], references: [id])
  studentId String @db.Uuid

  // Denormalized for efficient queries
  /// @DtoApiHidden
  module   Module @relation(fields: [moduleId], references: [id])
  moduleId String @db.Uuid

  /// @DtoApiHidden
  moduleContent   ModuleContent @relation(fields: [moduleContentId], references: [id])
  moduleContentId String        @db.Uuid

  status         ProgressStatus @default(NOT_STARTED)
  completedAt    DateTime?
  timeSpent      Int? // in seconds
  lastAccessedAt DateTime?

  /// @DtoReadOnly
  createdAt DateTime @default(now())
  /// @DtoReadOnly
  updatedAt DateTime @updatedAt

  @@unique([studentId, moduleContentId])
  @@index([studentId, moduleId])
  @@index([moduleContentId])
  @@index([completedAt])
  @@index([moduleId])
}

enum AppointmentStatus {
  booked
  approved
  cancelled
  rescheduled
  finished
  extended
}

model Appointment {
  id String @id @default(uuid()) @db.Uuid

  courseId  String         @db.Uuid
  /// @DtoApiHidden
  course    CourseOffering @relation(fields: [courseId], references: [id])
  studentId String         @db.Uuid
  /// @DtoApiHidden
  student   User           @relation("AppointmentStudent", fields: [studentId], references: [id])
  mentorId  String         @db.Uuid
  /// @DtoApiHidden
  mentor    User           @relation("AppointmentMentor", fields: [mentorId], references: [id])

  title        String
  description  String
  startAt      DateTime
  endAt        DateTime
  status       AppointmentStatus @default(booked)
  gmeetLink    String?
  cancelReason String?

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  updatedAt DateTime  @updatedAt
  /// @DtoReadOnly
  deletedAt DateTime?
}

model Notification {
  id String @id @default(uuid()) @db.Uuid

  receipts NotificationReceipt[]

  title   String
  content String
  role    Role[]

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  deletedAt DateTime?
}

model NotificationReceipt {
  id String @id @default(uuid()) @db.Uuid

  notificationId String       @db.Uuid
  notification   Notification @relation(fields: [notificationId], references: [id])
  userId         String       @db.Uuid
  /// @DtoApiHidden
  user           User         @relation(fields: [userId], references: [id])

  isRead  Boolean @default(false)

  /// @DtoReadOnly
  createdAt DateTime  @default(now())
  /// @DtoReadOnly
  deletedAt DateTime?
}